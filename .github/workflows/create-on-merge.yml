name: Release on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Configure git
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"

      - name: Get version from gem
        id: version
        run: |
          VERSION=$(ruby -r './lib/lamby/version.rb' -e 'puts Lamby::VERSION')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configurationJson: |
            {
              "template": "# Changelog\n\n## v${{ steps.version.outputs.version }} ($(date +%Y-%m-%d))\n\n#{{CHANGELOG}}\n\n### ðŸ“‹ Release Notes\n\nThis release includes #{{CATEGORIZED_COUNT}} changes from #{{UNCATEGORIZED_COUNT}} contributors.\n\n---\n*Generated by release automation*",
              "categories": [
                {
                  "title": "### ðŸš€ Added",
                  "labels": ["enhancement", "feature", "added"]
                },
                {
                  "title": "### ðŸ”§ Changed", 
                  "labels": ["changed", "updated"]
                },
                {
                  "title": "### ðŸ› Fixed",
                  "labels": ["bug", "bugfix", "fix", "fixed"]
                },
                {
                  "title": "### ðŸ—‘ï¸ Removed",
                  "labels": ["removed", "breaking"]
                },
                {
                  "title": "### ðŸ”’ Security",
                  "labels": ["security"]
                },
                {
                  "title": "### ðŸ“¦ Dependencies",
                  "labels": ["dependencies", "deps"]
                },
                {
                  "title": "### ðŸ”„ Other",
                  "labels": []
                }
              ],
              "pr_template": "- #{{TITLE}} (#{{NUMBER}})",
              "body_template": "#{{BODY}}"
            }
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Create CHANGELOG.md
        run: |
          # Create the main changelog
          echo '${{steps.build_changelog.outputs.changelog}}' > CHANGELOG.md
          
          # Add any custom release notes if they exist
          if [ -f ".github/release-notes.md" ]; then
            echo "" >> CHANGELOG.md
            echo "### ðŸ“ Additional Release Notes" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            cat .github/release-notes.md >> CHANGELOG.md
            rm .github/release-notes.md  # Clean up after use
          fi
          
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG.md for v${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin master || echo "Nothing to push"